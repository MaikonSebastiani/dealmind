generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// USER MODEL
// ==========================================

model User {
  id        String   @id @default(uuid())
  name      String?
  email     String   @unique
  emailVerified DateTime?
  image     String?
  password  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  accounts  Account[]
  sessions  Session[]
  deals     Deal[]

  @@map("users")
}

// ==========================================
// NEXTAUTH MODELS
// ==========================================

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// ENUMS
// ==========================================

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  LAND
  INDUSTRIAL
  MIXED
}

enum DealStatus {
  ANALYZING     // Em análise
  APPROVED      // Aprovado para compra
  REJECTED      // Rejeitado
  PURCHASED     // Comprado
  RENOVATING    // Em reforma
  FOR_SALE      // À venda
  SOLD          // Vendido
}

// ==========================================
// DEAL MODEL
// ==========================================

model Deal {
  id                 String       @id @default(uuid())
  userId             String
  
  // Basic Info
  name               String
  address            String?
  zipCode            String?
  propertyType       PropertyType @default(RESIDENTIAL)
  status             DealStatus   @default(ANALYZING)
  
  // Financial Inputs
  purchasePrice      Decimal      @db.Decimal(12, 2)
  estimatedCosts     Decimal      @db.Decimal(12, 2) @default(0)
  monthlyExpenses    Decimal      @db.Decimal(10, 2) @default(0)
  estimatedSalePrice Decimal      @db.Decimal(12, 2)
  
  // Financing (optional)
  useFinancing       Boolean      @default(false)
  downPayment        Decimal?     @db.Decimal(12, 2)
  loanAmount         Decimal?     @db.Decimal(12, 2)
  interestRate       Decimal?     @db.Decimal(5, 2)  // Annual rate %
  loanTermYears      Int?
  monthlyPayment     Decimal?     @db.Decimal(10, 2)
  closingCosts       Decimal?     @db.Decimal(10, 2)
  
  // Timeline
  estimatedTimeMonths Int         @default(12)
  
  // Calculated (stored for performance)
  estimatedProfit    Decimal?     @db.Decimal(12, 2)
  estimatedROI       Decimal?     @db.Decimal(5, 2)  // ROI on cash invested (Cash-on-Cash)
  
  // Metadata
  notes              String?      @db.Text
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relation
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  analyses   Analysis[]  
  documents  Document[] 

  @@index([userId])
  @@index([status])
  @@map("deals")
}

// ==========================================
// ANALYSIS ENUMS
// ==========================================

enum AnalysisType {
  FINANCIAL    // ROI, profit analysis
  DOCUMENT     // Document extraction
  RISK         // Risk assessment
}

// ==========================================
// ANALYSIS MODEL
// ==========================================

model Analysis {
  id           String       @id @default(uuid())
  dealId       String
  type         AnalysisType
  
  // AI Results
  summary      String?      @db.Text
  risks        Json?        // Array of risk objects
  insights     Json?        // Key insights extracted
  score        Int?         // 0-100 deal score
  
  // Scenarios (for FINANCIAL type)
  conservative Json?        // { roi, profit, timeline }
  moderate     Json?        // { roi, profit, timeline }
  optimistic   Json?        // { roi, profit, timeline }
  
  createdAt    DateTime     @default(now())

  // Relation
  deal         Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("analyses")
}

// ==========================================
// DOCUMENT ENUMS
// ==========================================

enum DocumentType {
  AUCTION_NOTICE     // Edital de leilão
  PROPERTY_REGISTRY  // Matrícula do imóvel
  CONTRACT           // Contrato
  INSPECTION         // Laudo de vistoria
  OTHER
}

// ==========================================
// DOCUMENT MODEL
// ==========================================

model Document {
  id            String       @id @default(uuid())
  dealId        String
  
  name          String
  type          DocumentType
  url           String       // Storage URL
  size          Int          // bytes
  mimeType      String
  
  // AI Extraction
  extractedText String?      @db.Text
  summary       String?      @db.Text
  keyPoints     Json?        // Array of key points
  
  createdAt     DateTime     @default(now())
  
  // Relation
  deal          Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("documents")
}